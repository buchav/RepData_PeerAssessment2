---
title: "RepData2"
author: "Victor Bucha"
date: "23 September 2015"
output: html_document
keep_md: true
---
#Synopsis
http://www.rpubs.com/rdpeng/13396
https://rstudio-pubs-static.s3.amazonaws.com/23679_859112a518404d4ba0ecbe89a7da8ef0.html
https://rstudio-pubs-static.s3.amazonaws.com/49350_fe68dff27e474b0292de36c33952f729.html
https://rpubs.com/egrjogonzalez/35369
https://rstudio-pubs-static.s3.amazonaws.com/50334_18a6b7f7dd6949b1ade7b9f0dd4192ce.html

DOC about variables
https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf

#Data Processing
###Reading the data
Let us load needed packages. Data.table package is used for fast .csv file loading.
``` {R load packages}
library(data.table)
library(dplyr,warn.conflicts=FALSE)
library(ggplot2)
library(tidyr)
```

``` {R loadingdata,cache=TRUE}
# read csv from connection
df.raw<-fread("repdata-data-StormData.csv",
        sep=",",header=TRUE,verbose = FALSE,na.strings ="",stringsAsFactors=TRUE)
```

Data relevant to the assignment is stored in a few columns- EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP. In addition, we have interest in values greather than 0. Let us select only needed colunms and filter out non-zero values in order to save system resources for further processing.
``` {R basic cleaning}
relevant.columns<-df.raw %>% select(EVTYPE,FATALITIES:CROPDMGEXP) %>% 
        filter(FATALITIES>0|INJURIES>0|PROPDMG>0|CROPDMG>0)

```

The event type is stored in EVTYPES column. There are many duplicated types of events. Let us combine duplicated types together and store result in new colunm BTYPE.
``` {R merge duplicated EVTYPES}
f<-(relevant.columns$EVTYPE)
f[grepl("wind",f,ignore.case = TRUE)]="WIND"
f[grepl("rain",f,ignore.case = TRUE)]="RAIN"
f[grepl("flood",f,ignore.case = TRUE)]="FLOOD"
f[grepl("heat",f,ignore.case = TRUE)]="HEAT"
f[grepl("cold",f,ignore.case = TRUE)]="COLD"
f[grepl("lightning",f,ignore.case = TRUE)]="LIGHTNING"
f[grepl("tornado",f,ignore.case = TRUE)]="TORNADO"
f[grepl("snow|blizzard",f,ignore.case = TRUE)]="SNOW"
f[grepl("hurricane|tropical",f,ignore.case = TRUE)]="HURRICANE"
f[grepl("hail",f,ignore.case = TRUE)]="HAIL"
#create new column BTYPE that has wider categories without duplication
relevant.columns$BTYPE<-f
```

Economical damage includes property and crop damage. We will estimate total economic damage as a sum of property and crop damage. The damage value is represented in two parts - mantissa and exponenta. Mantissa is stored in PROPDMG and CROPDMG fields. Exponenta is stored in PROPDMGEXP and CROPDMGEXP. Exponenta is coded with character "K"=1e3,"M"=1e6,"B"=1e9. Other codes of exponent were not defined clearly in a reference document so we ignore that records. Let us convert damage to proper numeric value.

``` {R convert damage to numeric,cache=TRUE}
#define lookup table for exponent
lookup<-c(K=1000,M=1e6,B=1e9)
relevant.columns<-relevant.columns %>% 
        mutate(PROPERTY.DMG=ifelse(toupper(PROPDMGEXP) %in% names(lookup),
                                       lookup[toupper(PROPDMGEXP)]*PROPDMG,0),
               CROP.DMG=ifelse(toupper(CROPDMGEXP) %in% names(lookup),
                               lookup[toupper(CROPDMGEXP)]*CROPDMG,0)) %>%
        select (-c(PROPDMGEXP,PROPDMG,CROPDMGEXP,CROPDMG))

```

``` {R Summarization of health and economic damages}
damage<-relevant.columns %>% group_by(BTYPE) %>% 
        summarise(INJURIES=sum(INJURIES),FATALITIES=sum(FATALITIES),
                  PROPERTY=sum(PROPERTY.DMG)/10e6,CROP=sum(CROP.DMG)/10e6) %>%
        mutate(TOTAL_HEALTH=INJURIES+FATALITIES,
               TOTAL_ECONOMIC=(PROPERTY+CROP))

```

#Results

``` {R answer Q1 question}
damage<-damage %>% arrange(-TOTAL_HEALTH)
top10.harm_health<-damage[1:10] %>%
        select(BTYPE,INJURIES,FATALITIES,TOTAL_HEALTH) %>%
        gather(DAMAGE.TYPE,COUNT,-c(BTYPE,TOTAL_HEALTH))

#sort factor in descending order ot total health damage
top10.harm_health$BTYPE<-with (top10.harm_health,reorder(BTYPE,-TOTAL_HEALTH))

ggplot(top10.harm_health,aes(x=BTYPE,y=COUNT,fill=DAMAGE.TYPE))+
        geom_bar(stat = "identity")+
        theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
        labs(title="Total population health damage in US. 1950-2011 ",x="Event",y="Count")
```


``` {R answer Q2 question}
damage<-damage %>% arrange(-TOTAL_ECONOMIC)

top10.harm_econ<-damage[1:10] %>%
        select(BTYPE,PROPERTY,CROP,TOTAL_ECONOMIC) %>%
        gather(DAMAGE.TYPE,COUNT,-c(BTYPE,TOTAL_ECONOMIC))

#sort factor in descending order ot total health damage
top10.harm_econ$BTYPE<-with (top10.harm_econ,reorder(BTYPE,-TOTAL_ECONOMIC))

ggplot(top10.harm_econ,aes(x=BTYPE,y=COUNT,fill=DAMAGE.TYPE))+
        geom_bar(stat = "identity")+
        theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
        labs(title="Total economic damage in US. 1950-2011",x="Event",y="US Dollars (in millions)")
```
